<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>KKClaw Switch</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
  background: linear-gradient(145deg, #0a0a14 0%, #0d1117 40%, #0f1520 100%);
  color: #e0e0e0; user-select: none; overflow-y: auto; overflow-x: hidden;
  min-height: 100vh;
}

/* èƒŒæ™¯å…‰æ™•è£…é¥° */
body::before {
  content: ''; position: fixed; top: -120px; right: -80px;
  width: 300px; height: 300px; border-radius: 50%;
  background: radial-gradient(circle, #7C6BF015 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; bottom: -100px; left: -60px;
  width: 250px; height: 250px; border-radius: 50%;
  background: radial-gradient(circle, #4ECDC410 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* æ»šåŠ¨æ¡ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ffffff15; border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: #ffffff30; }

/* ===== ç‰ç’ƒæ ‡é¢˜æ  ===== */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px 12px; position: sticky; top: 0; z-index: 10;
  background: rgba(12, 12, 20, 0.85); backdrop-filter: blur(20px) saturate(1.2);
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.header-left { display: flex; align-items: center; gap: 10px; }
.header-title {
  font-size: 17px; font-weight: 700;
  background: linear-gradient(135deg, #a78bfa, #67e8f9);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.5px;
}
.header-right { display: flex; align-items: center; gap: 5px; }
.header-tab {
  padding: 5px 12px; border-radius: 10px; font-size: 12px; font-weight: 500;
  cursor: pointer; color: #666; transition: all 0.3s; border: 1px solid transparent;
}
.header-tab:hover { color: #bbb; background: rgba(255,255,255,0.04); }
.header-tab.active {
  color: #e0e0e0;
  background: linear-gradient(135deg, rgba(124,107,240,0.12), rgba(78,205,196,0.08));
  border-color: rgba(124,107,240,0.2);
  box-shadow: 0 0 12px rgba(124,107,240,0.08);
}
.header-add {
  width: 28px; height: 28px; border-radius: 10px; border: none;
  background: linear-gradient(135deg, #7C6BF0, #6366F1); color: #fff;
  font-size: 18px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.3s; margin-left: 2px;
  box-shadow: 0 2px 8px rgba(124,107,240,0.3);
}
.header-add:hover { transform: scale(1.08); box-shadow: 0 4px 16px rgba(124,107,240,0.4); }
.lang-toggle {
  font-size: 10px; color: #555; cursor: pointer; padding: 3px 7px;
  border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); transition: all 0.2s;
  margin-right: 4px;
}
.lang-toggle:hover { color: #aaa; background: rgba(255,255,255,0.05); }

/* ===== ç‰ç’ƒå¡ç‰‡åŸºç¡€ ===== */
.glass-card {
  background: linear-gradient(135deg, rgba(20,22,36,0.8), rgba(24,28,48,0.6));
  border-radius: 14px; border: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  box-shadow: 0 2px 12px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.03);
  transition: all 0.3s;
}
.glass-card:hover {
  border-color: rgba(255,255,255,0.1);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
}

/* ===== å½“å‰æ¨¡å‹æŒ‡ç¤ºå™¨ ===== */
.current-indicator {
  margin: 0 16px 12px; padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
}
.current-indicator::before {
  content: ''; position: absolute; top: -30px; right: -20px;
  width: 100px; height: 100px; border-radius: 50%;
  background: radial-gradient(circle, rgba(124,107,240,0.15), transparent);
  pointer-events: none;
}
.current-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 16px; color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  position: relative; z-index: 1;
}
.current-info { flex: 1; position: relative; z-index: 1; }
.current-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; }
.current-model-name { font-size: 16px; font-weight: 700; color: #fff; margin-top: 2px; }
.current-provider-name { font-size: 11px; color: #555; margin-top: 1px; }
.current-switch-btn {
  padding: 7px 16px; border-radius: 10px;
  border: 1px solid rgba(124,107,240,0.25);
  background: linear-gradient(135deg, rgba(124,107,240,0.1), rgba(99,102,241,0.05));
  color: #a78bfa; font-size: 12px; font-weight: 500;
  cursor: pointer; transition: all 0.3s; position: relative; z-index: 1;
}
.current-switch-btn:hover {
  background: linear-gradient(135deg, rgba(124,107,240,0.2), rgba(99,102,241,0.1));
  box-shadow: 0 0 16px rgba(124,107,240,0.15);
}

/* ===== Provider å¡ç‰‡ ===== */
.provider-list { padding: 0 14px 14px; }
.provider-card {
  padding: 14px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; position: relative; overflow: hidden;
}
.provider-card.current {
  border-color: rgba(78,205,196,0.25);
  background: linear-gradient(135deg, rgba(15,42,40,0.8), rgba(20,50,48,0.5));
  box-shadow: 0 2px 16px rgba(78,205,196,0.08), inset 0 1px 0 rgba(78,205,196,0.05);
}
.provider-card.current::after {
  content: ''; position: absolute; top: -20px; right: -10px;
  width: 60px; height: 60px; border-radius: 50%;
  background: radial-gradient(circle, rgba(78,205,196,0.12), transparent);
}

.drag-handle { display: flex; flex-direction: column; gap: 2px; cursor: grab; opacity: 0.2; padding: 3px; transition: opacity 0.2s; }
.drag-handle:hover { opacity: 0.5; }
.drag-dot { display: flex; gap: 2px; }
.drag-dot span { width: 2px; height: 2px; border-radius: 50%; background: #888; }

.provider-icon {
  width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 15px; color: #fff;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
}
.provider-info { flex: 1; min-width: 0; }
.provider-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.provider-name { font-size: 13px; font-weight: 600; color: #eee; }
.provider-badge {
  font-size: 9px; padding: 2px 7px; border-radius: 6px; font-weight: 600;
  background: linear-gradient(135deg, rgba(78,205,196,0.15), rgba(78,205,196,0.08));
  color: #67e8f9; border: 1px solid rgba(78,205,196,0.15);
}
.provider-url { font-size: 10px; color: #444; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }

.provider-right { text-align: right; flex-shrink: 0; }
.provider-speed { font-size: 11px; color: #555; margin-bottom: 2px; }
.provider-speed.fast { color: #67e8f9; }
.provider-speed.medium { color: #fbbf24; }
.provider-speed.slow { color: #f87171; }
.provider-models-count { font-size: 10px; color: #444; }
.provider-actions-row { display: flex; gap: 3px; margin-top: 4px; justify-content: flex-end; }

/* ===== æ¨¡å‹åˆ—è¡¨ ===== */
.model-panel { padding: 0 14px 14px; }
.model-section-title {
  font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1.5px;
  padding: 8px 0 4px; font-weight: 600;
}
.model-grid { display: flex; flex-direction: column; gap: 3px; margin-bottom: 10px; }
.model-row {
  display: flex; align-items: center; gap: 8px; padding: 8px 10px;
  border-radius: 10px; cursor: pointer; transition: all 0.2s;
}
.model-row:hover { background: rgba(255,255,255,0.03); }
.model-row.active {
  background: linear-gradient(135deg, rgba(124,107,240,0.08), rgba(99,102,241,0.04));
  box-shadow: inset 0 0 0 1px rgba(124,107,240,0.15);
}
.model-icon-sm {
  width: 26px; height: 26px; border-radius: 7px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 10px; color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.model-name-text { font-size: 12px; flex: 1; color: #ccc; }
.model-tags { display: flex; gap: 3px; align-items: center; }
.model-tag {
  font-size: 9px; padding: 1px 6px; border-radius: 5px;
  background: rgba(255,255,255,0.04); color: #666;
  border: 1px solid rgba(255,255,255,0.04);
}
.model-tag.reasoning { background: rgba(251,191,36,0.08); color: #fbbf24; border-color: rgba(251,191,36,0.1); }
.model-check-mark { font-size: 13px; color: #a78bfa; width: 18px; text-align: center; }

/* ===== æ·»åŠ  Provider ===== */
.add-panel { padding: 10px 14px; }
.preset-section-title { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 8px; }
.preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
.preset-card {
  background: linear-gradient(135deg, rgba(20,22,36,0.7), rgba(24,28,48,0.5));
  border-radius: 12px; padding: 10px 8px; text-align: center; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.04); transition: all 0.3s; position: relative;
  backdrop-filter: blur(8px);
}
.preset-card:hover {
  border-color: rgba(255,255,255,0.12); transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
.preset-card.selected {
  border-color: rgba(124,107,240,0.4);
  background: linear-gradient(135deg, rgba(124,107,240,0.1), rgba(99,102,241,0.05));
  box-shadow: 0 0 20px rgba(124,107,240,0.1);
}
.preset-card-icon {
  width: 30px; height: 30px; border-radius: 8px; margin: 0 auto 4px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 13px; color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.preset-card-name { font-size: 10px; font-weight: 600; color: #ccc; }
.preset-card-desc { font-size: 9px; color: #555; margin-top: 1px; }
.preset-card-count {
  position: absolute; top: 4px; right: 4px;
  font-size: 8px; background: rgba(255,255,255,0.06); padding: 1px 4px;
  border-radius: 4px; color: #666;
}

/* ===== ç‰ç’ƒè¡¨å• ===== */
.form-section { margin-top: 12px; }
.form-group { margin-bottom: 10px; }
.form-label { font-size: 11px; color: #666; margin-bottom: 3px; display: block; font-weight: 500; }
.form-input {
  width: 100%; padding: 9px 12px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(10,10,18,0.6); color: #e0e0e0; font-size: 12px; outline: none;
  transition: all 0.3s; backdrop-filter: blur(4px);
}
.form-input:focus {
  border-color: rgba(124,107,240,0.4);
  box-shadow: 0 0 12px rgba(124,107,240,0.1);
}
.form-input::placeholder { color: #333; }
.form-select {
  width: 100%; padding: 9px 12px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(10,10,18,0.6); color: #e0e0e0; font-size: 12px;
  outline: none; cursor: pointer;
}
.form-row { display: flex; gap: 8px; }
.form-row > * { flex: 1; }
.form-hint { font-size: 10px; color: #444; margin-top: 3px; }

/* ===== ç¼–è¾‘é¢æ¿ ===== */
.edit-panel { padding: 10px 14px; }
.edit-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.edit-back {
  width: 30px; height: 30px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.02); color: #666; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.edit-back:hover { background: rgba(255,255,255,0.06); color: #ccc; }
.edit-title { font-size: 15px; font-weight: 600; }
.edit-provider-icon {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 14px; color: #fff;
}

/* ===== ç‰ç’ƒæŒ‰é’® ===== */
.btn {
  padding: 7px 14px; border-radius: 10px; border: none;
  font-size: 11px; cursor: pointer; font-weight: 500; transition: all 0.3s;
  display: inline-flex; align-items: center; gap: 4px;
}
.btn-primary {
  background: linear-gradient(135deg, #7C6BF0, #6366F1); color: #fff;
  box-shadow: 0 3px 12px rgba(124,107,240,0.3);
}
.btn-primary:hover { box-shadow: 0 5px 20px rgba(124,107,240,0.4); transform: translateY(-1px); }
.btn-danger {
  background: rgba(248,113,113,0.08); color: #f87171;
  border: 1px solid rgba(248,113,113,0.15);
}
.btn-danger:hover { background: rgba(248,113,113,0.15); }
.btn-ghost {
  background: rgba(255,255,255,0.03); color: #888;
  border: 1px solid rgba(255,255,255,0.06);
}
.btn-ghost:hover { background: rgba(255,255,255,0.06); color: #ccc; }
.btn-speed {
  background: rgba(103,232,249,0.06); color: #67e8f9;
  border: 1px solid rgba(103,232,249,0.15);
}
.btn-speed:hover { background: rgba(103,232,249,0.12); }
.btn-sm { padding: 4px 8px; font-size: 10px; border-radius: 7px; }
.btn-block { width: 100%; justify-content: center; }

.divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); margin: 12px 0; }

/* ===== Toast ===== */
.toast {
  position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
  padding: 8px 20px; border-radius: 12px; font-size: 12px; font-weight: 500;
  opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
  backdrop-filter: blur(16px);
}
.toast.show { opacity: 1; }
.toast-success { background: rgba(39,174,96,0.9); color: #fff; box-shadow: 0 4px 16px rgba(39,174,96,0.3); }
.toast-error { background: rgba(231,76,60,0.9); color: #fff; box-shadow: 0 4px 16px rgba(231,76,60,0.3); }
.toast-info { background: rgba(52,152,219,0.9); color: #fff; box-shadow: 0 4px 16px rgba(52,152,219,0.3); }

.panel { display: none; }
.panel.active { display: block; }

.empty-state { text-align: center; padding: 32px 16px; color: #444; }
.empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.2; }
.empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.empty-hint { font-size: 11px; color: #333; }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.testing { animation: pulse 1s infinite; }

.model-edit-row {
  display: flex; align-items: center; gap: 8px; padding: 5px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.model-edit-row:last-child { border-bottom: none; }
.model-edit-name { flex: 1; font-size: 12px; }
.model-edit-id { font-size: 10px; color: #444; flex: 1; }
</style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="header">
  <div class="header-left">
    <span class="header-title">KKClaw Switch</span>
  </div>
  <div class="header-right">
    <span class="lang-toggle" onclick="toggleLang()" id="langBtn">ä¸­/EN</span>
    <div class="header-tab active" data-tab="main" onclick="showTab('main')"><span data-t="providers">æœåŠ¡å•†</span></div>
    <div class="header-tab" data-tab="models" onclick="showTab('models')"><span data-t="models">æ¨¡å‹</span></div>
    <button class="header-add" onclick="showTab('add')" title="æ·»åŠ ">+</button>
  </div>
</div>

<!-- Panel 1: Provider åˆ—è¡¨ -->
<div id="panel-main" class="panel active">
  <div class="current-indicator glass-card" id="currentIndicator"></div>
  <div style="padding: 0 14px 6px; display: flex; gap: 6px; flex-wrap: wrap;">
    <button class="btn btn-speed btn-sm" onclick="speedTestAll()" id="speedTestAllBtn"><span data-t="testAll">â± å…¨éƒ¨æµ‹é€Ÿ</span></button>
    <button class="btn btn-ghost btn-sm" onclick="refreshAll()"><span data-t="refresh">â†» åˆ·æ–°</span></button>
    <button class="btn btn-ghost btn-sm" onclick="importFromCCSwitch()" id="importFromCCSwitchBtn"><span data-t="importFromCC">â¬‡ ä»CC Switchå¯¼å…¥</span></button>
  </div>
  <div class="provider-list" id="providerList"></div>
</div>

<!-- Panel 2: æ¨¡å‹åˆ—è¡¨ -->
<div id="panel-models" class="panel">
  <div class="model-panel" id="modelPanel"></div>
</div>

<!-- Panel 3: æ·»åŠ  Provider -->
<div id="panel-add" class="panel">
  <div class="add-panel">
    <div class="preset-section-title"><span data-t="presetTitle">é€‰æ‹©é¢„è®¾</span></div>
    <div class="preset-grid" id="presetGrid"></div>
    
    <div class="form-hint" style="text-align: center; margin-bottom: 12px;">
      <span data-t="presetHint">ğŸ’¡ é€‰æ‹©é¢„è®¾ååªéœ€å¡«å†™ API Key</span><br>
      <span style="color:#67e8f9; font-size:10px;"><span data-t="relayHint">æ²¡æœ‰ API Keyï¼Ÿè¯•è¯•</span> <a href="https://api.kk666.online" target="_blank" style="color:#a78bfa;text-decoration:none;">api.kk666.online</a></span>
    </div>
    
    <div class="divider"></div>
    
    <div class="form-section">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label"><span data-t="providerName">åç§°</span> *</label>
          <input class="form-input" id="addName" placeholder="e.g. MyOpenAI">
        </div>
        <div class="form-group">
          <label class="form-label"><span data-t="notes">å¤‡æ³¨</span></label>
          <input class="form-input" id="addNotes" placeholder="e.g. å…¬å¸è´¦å·">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Base URL *</label>
        <input class="form-input" id="addBaseUrl" placeholder="https://api.kk666.online/v1" value="https://api.kk666.online/v1">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">API Key *</label>
          <input class="form-input" id="addApiKey" type="password" placeholder="sk-...">
        </div>
        <div class="form-group">
          <label class="form-label"><span data-t="apiType">æ¥å£ç±»å‹</span></label>
          <select class="form-select" id="addApiType">
            <option value="anthropic-messages">Anthropic Messages (Claude)</option>
            <option value="openai-completions">OpenAI Completions (GPT/DeepSeek/Gemini/Qwen...)</option>
            <option value="openai-responses">OpenAI Responses (GPT-5/Codex)</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      
      <div style="font-size: 11px; color: #666; margin-bottom: 6px;"><span data-t="modelsOptional">æ¨¡å‹ï¼ˆå¯é€‰ï¼‰</span></div>
      <div id="addModelRows">
        <div class="form-row" style="margin-bottom: 6px;">
          <input class="form-input" placeholder="Model ID (e.g. gpt-4o)" data-field="id">
          <input class="form-input" placeholder="æ˜¾ç¤ºåç§°" data-field="name">
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-bottom: 12px;" onclick="addModelRow()"><span data-t="addModel">+ æ·»åŠ æ¨¡å‹</span></button>

      <div style="display: flex; gap: 8px;">
        <button class="btn btn-primary btn-block" onclick="submitProvider()"><span data-t="addBtn">+ æ·»åŠ </span></button>
        <button class="btn btn-ghost" onclick="showTab('main')"><span data-t="cancel">å–æ¶ˆ</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Panel 4: ç¼–è¾‘ -->
<div id="panel-edit" class="panel">
  <div class="edit-panel" id="editPanel"></div>
</div>

<div class="toast" id="toast"></div>

<script>
let ipcRenderer;
try { ipcRenderer = require('electron').ipcRenderer; } catch(e) {}

let allModels = [], allProviders = [], currentModel = null, selectedPreset = null, editingProvider = null;

// ===== i18n =====
let currentLang = 'zh';
const i18n = {
  zh: { providers:'æœåŠ¡å•†', models:'æ¨¡å‹', testAll:'â± å…¨éƒ¨æµ‹é€Ÿ', refresh:'â†» åˆ·æ–°',
    currentlyUsing:'å½“å‰ä½¿ç”¨', switchBtn:'åˆ‡æ¢', noModel:'æœªé€‰æ‹©æ¨¡å‹',
    noProviders:'æš‚æ— æœåŠ¡å•†', noProvidersHint:'ç‚¹å‡» + æ·»åŠ ', presetTitle:'é€‰æ‹©é¢„è®¾',
    presetHint:'ğŸ’¡ é€‰æ‹©é¢„è®¾ååªéœ€å¡«å†™ API Key', relayHint:'æ²¡æœ‰ API Keyï¼Ÿè¯•è¯•',
    providerName:'åç§°', notes:'å¤‡æ³¨', apiType:'æ¥å£ç±»å‹', modelsOptional:'æ¨¡å‹ï¼ˆå¯é€‰ï¼‰',
    addModel:'+ æ·»åŠ æ¨¡å‹', addBtn:'+ æ·»åŠ ', cancel:'å–æ¶ˆ', displayName:'æ˜¾ç¤ºåç§°',
    noModels:'æš‚æ— æ¨¡å‹', noModelsHint:'è¯·å…ˆæ·»åŠ æœåŠ¡å•†', saveChanges:'ä¿å­˜', test:'â± æµ‹é€Ÿ',
    delete:'åˆ é™¤', keySet:'âœ… å·²é…ç½®', keyNotSet:'âŒ æœªé…ç½®',
    testing:'â± æµ‹é€Ÿä¸­...', testComplete:'æµ‹é€Ÿå®Œæˆ', refreshed:'å·²åˆ·æ–°',
    switched:'å·²åˆ‡æ¢åˆ°', added:'å·²æ·»åŠ ', updated:'å·²æ›´æ–°', deleted:'å·²åˆ é™¤', removed:'å·²ç§»é™¤',
    enterName:'è¯·è¾“å…¥åç§°', enterKey:'è¯·è¾“å…¥ API Key', enterModelId:'è¯·è¾“å…¥æ¨¡å‹ ID',
    noChanges:'æ— æ›´æ”¹', confirmDelete:'ç¡®è®¤åˆ é™¤', confirmDeleteHint:'ï¼Ÿæ‰€æœ‰æ¨¡å‹å°†ä¸å¯ç”¨',
    confirmRemove:'ç¡®è®¤ç§»é™¤æ¨¡å‹' },
  en: { providers:'Providers', models:'Models', testAll:'â± Test All', refresh:'â†» Refresh',
    currentlyUsing:'Currently Using', switchBtn:'Switch', noModel:'No model selected',
    noProviders:'No providers', noProvidersHint:'Click + to add', presetTitle:'Provider Preset',
    presetHint:'ğŸ’¡ Only need API Key', relayHint:"No API Key? Try",
    providerName:'Name', notes:'Notes', apiType:'API Type', modelsOptional:'Models (optional)',
    addModel:'+ Add Model', addBtn:'+ Add', cancel:'Cancel', displayName:'Display Name',
    noModels:'No models', noModelsHint:'Add a provider first', saveChanges:'Save', test:'â± Test',
    delete:'Delete', keySet:'âœ… Key set', keyNotSet:'âŒ No key',
    testing:'â± Testing...', testComplete:'Done!', refreshed:'Refreshed',
    switched:'Switched to', added:'Added', updated:'Updated', deleted:'Deleted', removed:'Removed',
    enterName:'Enter name', enterKey:'Enter API Key', enterModelId:'Enter model ID',
    noChanges:'No changes', confirmDelete:'Delete', confirmDeleteHint:'? All models unavailable.',
    confirmRemove:'Remove model' }
};
function t(k) { return i18n[currentLang][k] || i18n.en[k] || k; }
function toggleLang() { currentLang = currentLang==='zh'?'en':'zh'; document.getElementById('langBtn').textContent = currentLang==='zh'?'ä¸­/EN':'EN/ä¸­'; applyLang(); }
function applyLang() {
  document.querySelectorAll('[data-t]').forEach(el => { const k=el.getAttribute('data-t'); if(i18n[currentLang][k]) el.textContent=i18n[currentLang][k]; });
  if(document.getElementById('panel-main').classList.contains('active')){ renderCurrentIndicator(); renderProviderList(); }
  if(document.getElementById('panel-models').classList.contains('active')){ loadModels(); }
}

// ===== Tab =====
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.header-tab').forEach(t=>t.classList.remove('active'));
  const panel=document.getElementById(`panel-${name}`); if(panel) panel.classList.add('active');
  const tab=document.querySelector(`.header-tab[data-tab="${name}"]`); if(tab) tab.classList.add('active');
  if(name==='main') loadAll(); if(name==='models') loadModels(); if(name==='add') loadPresets();
}

async function loadAll() {
  if(!ipcRenderer) return;
  const s=await ipcRenderer.invoke('model-full-status'); if(!s) return;
  allModels=s.models||[]; allProviders=s.providers||[]; currentModel=s.current;
  renderCurrentIndicator(); renderProviderList();
}

function renderCurrentIndicator() {
  const el=document.getElementById('currentIndicator');
  if(!currentModel){ el.innerHTML=`<div class="empty-state" style="padding:12px;"><div class="empty-text">${t('noModel')}</div></div>`; return; }
  el.innerHTML=`
    <div class="current-icon" style="background:${currentModel.color}">${currentModel.icon}</div>
    <div class="current-info"><div class="current-label">${t('currentlyUsing')}</div>
    <div class="current-model-name">${currentModel.shortName}</div>
    <div class="current-provider-name">${currentModel.provider} Â· ${currentModel.modelId}</div></div>
    <button class="current-switch-btn" onclick="showTab('models')">${t('switchBtn')}</button>`;
}

function renderProviderList() {
  const el=document.getElementById('providerList');
  if(allProviders.length===0){ el.innerHTML=`<div class="empty-state"><div class="empty-icon">âŠ•</div><div class="empty-text">${t('noProviders')}</div><div class="empty-hint">${t('noProvidersHint')}</div></div>`; return; }
  el.innerHTML=allProviders.map(p=>{
    const cur=p.isCurrent, spd=renderSpeedBadge(p.speedTest);
    return `<div class="provider-card glass-card ${cur?'current':''}" onclick="switchProvider('${p.name}')" ondblclick="event.stopPropagation();editProvider('${p.name}')">
      <div class="drag-handle"><div class="drag-dot"><span></span><span></span></div><div class="drag-dot"><span></span><span></span></div><div class="drag-dot"><span></span><span></span></div></div>
      <div class="provider-icon" style="background:${p.color}">${p.icon}</div>
      <div class="provider-info"><div class="provider-name-row"><span class="provider-name">${p.name}</span>${cur?`<span class="provider-badge">${t('currentlyUsing')}</span>`:''}</div>
      <div class="provider-url">${p.website||p.baseUrl||''}</div></div>
      <div class="provider-right">${spd}<div class="provider-models-count">${p.modelCount} model${p.modelCount!==1?'s':''}</div>
      <div class="provider-actions-row"><button class="btn btn-speed btn-sm" onclick="event.stopPropagation();speedTest('${p.name}')">â±</button>
      <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();editProvider('${p.name}')">âœ</button></div></div></div>`;
  }).join('');
}

function renderSpeedBadge(s) {
  if(!s) return '<div class="provider-speed">--</div>';
  if(s.status==='error') return '<div class="provider-speed slow">Error</div>';
  const ms=s.latencyMs, cls=ms<1000?'fast':ms<3000?'medium':'slow';
  return `<div class="provider-speed ${cls}">${ms}ms</div>`;
}

async function speedTest(name) { if(!ipcRenderer) return; showToast(`${t('testing')}`,'info'); const r=await ipcRenderer.invoke('model-speed-test',name); showToast(r.status==='ok'?`${name}: ${r.latencyMs}ms`:`${name}: Error`,'success'); loadAll(); }
async function speedTestAll() { if(!ipcRenderer) return; const btn=document.getElementById('speedTestAllBtn'); btn.classList.add('testing'); showToast(t('testing'),'info'); await ipcRenderer.invoke('model-speed-test-all'); btn.classList.remove('testing'); showToast(t('testComplete'),'success'); loadAll(); }

async function importFromCCSwitch() {
  if(!ipcRenderer) return;
  if(!confirm('ç¡®å®šè¦ä» CC Switch å¯¼å…¥é…ç½®å—ï¼Ÿ\nå·²å­˜åœ¨çš„åŒåæœåŠ¡å•†å°†è¢«è·³è¿‡ã€‚')) return;
  const btn=document.getElementById('importFromCCSwitchBtn');
  btn.disabled=true;
  showToast('æ­£åœ¨ä» CC Switch å¯¼å…¥...','info');
  try {
    const r=await ipcRenderer.invoke('import-from-ccswitch');
    if(r.success){
      showToast(`âœ… å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${r.providersCount} ä¸ªæœåŠ¡å•†`,'success');
      await loadAll();
    }else{
      showToast(`âŒ å¯¼å…¥å¤±è´¥: ${r.error}`,'error');
    }
  } catch(err) {
    showToast(`âŒ å¯¼å…¥å¤±è´¥: ${err.message}`,'error');
  } finally {
    btn.disabled=false;
  }
}

async function loadModels() {
  if(!ipcRenderer) return;
  const s=await ipcRenderer.invoke('model-full-status'); if(!s) return;
  allModels=s.models||[]; currentModel=s.current;
  const panel=document.getElementById('modelPanel'), groups={};
  for(const m of allModels){ if(!groups[m.provider]) groups[m.provider]=[]; groups[m.provider].push(m); }
  let html='';
  for(const [prov,models] of Object.entries(groups)){
    html+=`<div class="model-section-title">${prov}</div><div class="model-grid">`;
    for(const m of models){ const act=currentModel?.id===m.id; html+=`
      <div class="model-row ${act?'active':''}" onclick="switchModel('${m.id}')">
        <div class="model-icon-sm" style="background:${m.color}">${m.icon}</div>
        <div class="model-name-text">${m.shortName}</div>
        <div class="model-tags">${m.reasoning?'<span class="model-tag reasoning">ğŸ§ </span>':''}<span class="model-tag">${Math.round(m.contextWindow/1000)}K</span></div>
        <div class="model-check-mark">${act?'âœ“':''}</div></div>`; }
    html+='</div>';
  }
  if(!allModels.length) html=`<div class="empty-state"><div class="empty-icon">âŠ˜</div><div class="empty-text">${t('noModels')}</div><div class="empty-hint">${t('noModelsHint')}</div></div>`;
  panel.innerHTML=html;
}

async function switchModel(id) { if(!ipcRenderer) return; const r=await ipcRenderer.invoke('model-switch',id); if(r){ showToast(`${t('switched')} ${r.shortName}`,'success'); loadModels(); } }

async function switchProvider(name) {
  if(!ipcRenderer) return;
  showToast(`åˆ‡æ¢åˆ° ${name}...`,'info');
  const r=await ipcRenderer.invoke('model-switch-provider',name);
  if(r){ showToast(`${t('switched')} ${name} / ${r.shortName}`,'success'); loadAll(); }
  else { showToast(`åˆ‡æ¢å¤±è´¥`,'error'); }
}

async function editProvider(name) {
  editingProvider=name; const s=await ipcRenderer.invoke('model-full-status');
  const p=s.providers.find(x=>x.name===name); if(!p) return;
  const models=allModels.filter(m=>m.provider===name);
  document.getElementById('editPanel').innerHTML=`
    <div class="edit-header"><button class="edit-back" onclick="showTab('main')">â†</button>
    <div class="edit-provider-icon" style="background:${p.color}">${p.icon}</div>
    <div><div class="edit-title">${name}</div><div style="font-size:10px;color:#555;">${p.apiType}</div></div></div>
    <div class="form-group"><label class="form-label">Base URL</label><input class="form-input" id="editBaseUrl" value="${p.baseUrl||''}"></div>
    <div class="form-group"><label class="form-label">API Key</label><input class="form-input" id="editApiKey" type="password" placeholder="${p.hasApiKey?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':''}">
    <div class="form-hint">${p.hasApiKey?t('keySet'):t('keyNotSet')}</div></div>
    <div style="display:flex;gap:6px;margin-top:10px;">
    <button class="btn btn-primary" onclick="saveProviderEdit()">${t('saveChanges')}</button>
    <button class="btn btn-speed" onclick="speedTest('${name}')">${t('test')}</button>
    <button class="btn btn-ghost" onclick="fetchProviderModels('${name}')">ğŸ“¡ è·å–æ¨¡å‹</button>
    <button class="btn btn-danger" onclick="deleteProvider('${name}')">${t('delete')}</button></div>
    <div class="divider"></div>
    <div style="font-size:12px;font-weight:600;color:#888;margin-bottom:6px;">${t('models')} (${models.length})</div>
    ${models.map(m=>`<div class="model-edit-row"><div class="model-icon-sm" style="background:${m.color};width:22px;height:22px;font-size:9px;">${m.icon}</div>
    <div class="model-edit-name">${m.shortName}</div><div class="model-edit-id">${m.modelId}</div>
    <button class="btn btn-danger btn-sm" onclick="removeModel('${name}','${m.modelId}')">Ã—</button></div>`).join('')}
    <div style="margin-top:8px;"><div class="form-row" style="margin-bottom:6px;">
    <input class="form-input" id="newModelId" placeholder="Model ID" style="font-size:11px;">
    <input class="form-input" id="newModelName" placeholder="${t('displayName')}" style="font-size:11px;">
    <button class="btn btn-ghost btn-sm" onclick="addModelToProvider('${name}')">+</button></div></div>`;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.header-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-edit').classList.add('active');
}

async function saveProviderEdit() { if(!editingProvider||!ipcRenderer) return; const b=document.getElementById('editBaseUrl').value.trim(),k=document.getElementById('editApiKey').value.trim(),u={}; if(b) u.baseUrl=b; if(k) u.apiKey=k; if(!Object.keys(u).length){showToast(t('noChanges'),'info');return;} const r=await ipcRenderer.invoke('model-update-provider',editingProvider,u); if(r.success){showToast(`${t('updated')} ${editingProvider}`,'success');showTab('main');}else showToast(r.error,'error'); }
async function deleteProvider(name) { if(!confirm(`${t('confirmDelete')} "${name}"${t('confirmDeleteHint')}`)) return; const r=await ipcRenderer.invoke('model-remove-provider',name); if(r.success){showToast(`${t('deleted')} ${name}`,'success');showTab('main');}else showToast(r.error,'error'); }
async function removeModel(prov,id) { if(!confirm(`${t('confirmRemove')} "${id}"?`)) return; const r=await ipcRenderer.invoke('model-remove-model',prov,id); if(r.success){showToast(t('removed'),'success');editProvider(prov);await loadAll();}else showToast(r.error,'error'); }
async function addModelToProvider(prov) { const id=document.getElementById('newModelId').value.trim(),name=document.getElementById('newModelName').value.trim(); if(!id) return showToast(t('enterModelId'),'error'); const r=await ipcRenderer.invoke('model-add-model',prov,{id,name:name||id}); if(r.success){showToast(`${t('added')} ${id}`,'success');editProvider(prov);await loadAll();}else showToast(r.error,'error'); }

async function fetchProviderModels(prov) {
  if(!ipcRenderer) return;
  showToast('æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...','info');
  const r=await ipcRenderer.invoke('model-fetch-models',prov);
  if(!r.success){ showToast(`è·å–å¤±è´¥: ${r.error}`,'error'); return; }
  if(!r.models.length){ showToast('æœªè·å–åˆ°æ¨¡å‹','info'); return; }
  let added=0;
  for(const m of r.models){
    try{ await ipcRenderer.invoke('model-add-model',prov,{id:m.id,name:m.name||m.id}); added++; }catch(e){}
  }
  showToast(`è·å–åˆ° ${r.models.length} ä¸ªæ¨¡å‹ï¼Œæ–°å¢ ${added} ä¸ª`,'success');
  editProvider(prov);
  await loadAll();
}

async function loadPresets() { if(!ipcRenderer) return; const presets=await ipcRenderer.invoke('model-presets'); document.getElementById('presetGrid').innerHTML=presets.map(p=>`
  <div class="preset-card ${selectedPreset===p.key?'selected':''}" onclick="selectPreset('${p.key}')">
  <div class="preset-card-count">${p.modelCount}</div><div class="preset-card-icon" style="background:${p.color}">${p.icon}</div>
  <div class="preset-card-name">${p.name}</div><div class="preset-card-desc">${p.description||''}</div></div>`).join(''); }

function selectPreset(key) { if(!ipcRenderer) return; ipcRenderer.invoke('model-presets').then(presets=>{ const p=presets.find(x=>x.key===key); if(!p) return; selectedPreset=key; document.getElementById('addName').value=p.name; document.getElementById('addBaseUrl').value=p.baseUrl; document.getElementById('addApiType').value=p.api; document.querySelectorAll('.preset-card').forEach(el=>el.classList.remove('selected')); event.target.closest('.preset-card').classList.add('selected'); }); }

function addModelRow() { const c=document.getElementById('addModelRows'),r=document.createElement('div'); r.className='form-row'; r.style.marginBottom='6px'; r.innerHTML=`<input class="form-input" placeholder="Model ID" data-field="id"><input class="form-input" placeholder="${t('displayName')}" data-field="name">`; c.appendChild(r); }

async function submitProvider() {
  const name=document.getElementById('addName').value.trim(),baseUrl=document.getElementById('addBaseUrl').value.trim(),apiKey=document.getElementById('addApiKey').value.trim(),api=document.getElementById('addApiType').value;
  if(!name) return showToast(t('enterName'),'error'); if(!apiKey) return showToast(t('enterKey'),'error');
  let result; const fi=document.querySelector('#addModelRows .form-row input[data-field="id"]'),hm=fi&&fi.value.trim();
  if(selectedPreset&&!hm){ result=await ipcRenderer.invoke('model-add-from-preset',selectedPreset,apiKey,name,baseUrl||undefined); }
  else { const rows=document.querySelectorAll('#addModelRows .form-row'),models=[]; rows.forEach(r=>{const id=r.querySelector('[data-field="id"]').value.trim(),n=r.querySelector('[data-field="name"]').value.trim();if(id) models.push({id,name:n||id});}); result=await ipcRenderer.invoke('model-add-provider',name,{baseUrl,apiKey,api,models}); }
  if(result.success){showToast(`${t('added')} "${name}"`,'success');document.getElementById('addName').value='';document.getElementById('addBaseUrl').value='https://api.kk666.online/v1';document.getElementById('addApiKey').value='';selectedPreset=null;showTab('main');}else showToast(result.error,'error');
}

function refreshAll() { loadAll(); showToast(t('refreshed'),'info'); }
function showToast(msg,type='success') { const toast=document.getElementById('toast'); toast.textContent=msg; toast.className=`toast toast-${type} show`; setTimeout(()=>toast.classList.remove('show'),2500); }

loadAll();
if(ipcRenderer) { ipcRenderer.on('model-changed',()=>{loadAll();loadModels();}); }
</script>
</body>
</html>
